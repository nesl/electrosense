
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Train Regressoin Model using historical data</title><meta name="generator" content="MATLAB 7.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2013-10-22"><meta name="DC.source" content="RegressionScript_Ver03.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h1>Train Regressoin Model using historical data</h1><!--introduction--><p>Allows for flexible selection of data</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">select the data points to get</a></li><li><a href="#3">Get data</a></li><li><a href="#5">for distances 4 to 7 inches only</a></li><li><a href="#7">Autoscale</a></li><li><a href="#8">Regress Train</a></li><li><a href="#9">Regress Test</a></li></ul></div><h2>select the data points to get<a name="1"></a></h2><pre class="codeinput"><span class="comment">%clc;</span>
<span class="comment">%data_i = randperm(21);</span>
<span class="comment">%train_i = data_i(1:floor(length(data_i))/2);</span>
<span class="comment">%test_i = data_i((floor(length(data_i)/2)+1):end);</span>
s_norm = zeros(2,1);
<span class="comment">% index filter</span>
train_i = 1:57;
<span class="keyword">for</span> i = train_i
    <span class="comment">%basePath = 'C:\Users\newton\AeroFS\NESL_Software\electrosense\DATA\ModelWeekLogOrder3\AL\';</span>
    basePath = <span class="string">'/Users/newton/AeroFS/NESL_Software/electrosense/DATA/ModelWeekLogOrder3/AL/'</span>;
    [sys_train, OutputLog_a, x_a, y_a] = getData(basePath,i);

    <span class="comment">% get singular and/or norm values</span>
    s_norm(i) = norm(sys_train); <span class="comment">% id model norm</span>
<span class="keyword">end</span>
[s_norm_sorted, H2Norm_I] = sort(s_norm);

<span class="comment">%norm_limit = 0.6750;</span>
norm_lower_limit = 0;
<span class="comment">%norm_lower_limit = 0.685; % Determined through examination of the data</span>
<span class="comment">%norm_lower_limit = 0.71;</span>
<span class="comment">%norm_upper_limit = 0.720;</span>
norm_upper_limit = inf;
I1 = s_norm_sorted &gt; norm_lower_limit;
I2 = s_norm_sorted &lt; norm_upper_limit;
I = find(I1 &amp; I2);

<span class="comment">% set indexes here</span>
train_i = H2Norm_I(I);
<span class="comment">%rand_i = randperm(length(I));</span>
<span class="comment">%train_i = H2Norm_I(I(rand_i(1:floor(length(I)/2))));</span>
<span class="comment">%test_i = H2Norm_I(I(rand_i(ceil(length(I)/2):end)));</span>
</pre><h2>Get data<a name="3"></a></h2><pre class="codeinput">Anorm = zeros(2,1);
Snorm = zeros(2,1);
SnormINF = zeros(2,1);
Amat = {};
Xmat = [];
Ymat = [];
b4tharray = [];
bquadarray = [];
AnormArray = [];
xtemp = [];
ytemp = [];
<span class="keyword">for</span> i = 1:length(train_i)
    <span class="comment">%basePath = 'C:\Users\newton\AeroFS\NESL_Software\electrosense\DATA\ModelWeekLogOrder3\AL\';</span>
    <span class="comment">%basePath = 'C:\Users\newton\AeroFS\NESL_Software\electrosense\DATA\MURI\TestDistance\Update_flaw_3\Order3\';</span>
    basePath = <span class="string">'/Users/newton/AeroFS/NESL_Software/electrosense/DATA/ModelWeekLogOrder3/AL/'</span>;
    [sys_train, OutputLog, x, y] = getData(basePath,train_i(i));

    <span class="comment">% get singular and/or norm values</span>
    svd_values = svd(sys_train.A);
    Snorm(i) = norm(sys_train);
    SnormINF(i) = norm(sys_train,inf);

    <span class="comment">% include averaging to estimated values</span>
    xtemp2 = [];
    <span class="keyword">for</span> j = 1:size(x,1)/30
       starti = 1 + (j-1)*30;
       endi = starti + 29;
       xtemp2(j,:) = mean(x(starti:endi,:));
    <span class="keyword">end</span>
    addedFeature = kron(ones(size(xtemp2,1),1),Snorm(i));
    <span class="comment">%xtemp2 = [xtemp2, addedFeature];</span>
    xtemp = [xtemp; xtemp2];

    <span class="comment">% include averaging to estimate values</span>
    ytemp2 = [];
    <span class="keyword">for</span> j = 1:size(y,1)/30
      starti = 1 + (j-1)*30;
      endi = starti + 29;
      ytemp2(j,:) = mean(y(starti:endi,:));
    <span class="keyword">end</span>
    ytemp = [ytemp; ytemp2];
<span class="keyword">end</span>

<span class="comment">% include a subset of the distances measured</span>
class_label = 4:1:7;
xtemp2 = [];
ytemp2 = [];
<span class="keyword">for</span> j = 1:length(class_label)
   I = find(ytemp == class_label(j));
   xtemp2 = [xtemp2; xtemp(I,:)];
   ytemp2 = [ytemp2; ytemp(I)];
<span class="keyword">end</span>
xtemp = xtemp2;
ytemp = ytemp2;
</pre><h2>for distances 4 to 7 inches only<a name="5"></a></h2><pre class="codeinput">xtemp = exp(xtemp.*kron(ones(size(xtemp,1),1),[1000,500,5000]));
</pre><pre class="codeinput"><span class="comment">%Ymat_train = ytemp;</span>
<span class="comment">%Ymat_test = ytemp;</span>
<span class="comment">%Xmat_train = xtemp;</span>
<span class="comment">%Xmat_test = xtemp;</span>

<span class="comment">%split data</span>
P = cvpartition(ytemp,<span class="string">'Holdout'</span>,0.10);
Ymat_train = ytemp(P.training);
Ymat_test = ytemp(P.test);
Xmat_train = xtemp(P.training,:);
Xmat_test = xtemp(P.test,:);
</pre><h2>Autoscale<a name="7"></a></h2><pre class="codeinput">scaleData = [];
scaleData.shift = -mean(Xmat_train);
stdVal = std(Xmat_train);
scaleData.scaleFactor = 1./stdVal;
scaleData.scaleFactor(~isfinite(scaleData.scaleFactor)) = 1;
Xmat_train_a = [];
<span class="keyword">for</span> i=1:size(Xmat_train,2)
    Xmat_train_a(:,i) = scaleData.scaleFactor(i)*(Xmat_train(:,i) + scaleData.shift(i));
<span class="keyword">end</span>
</pre><h2>Regress Train<a name="8"></a></h2><pre class="codeinput">Y = Ymat_train;
X = [ ones(size(Xmat_train_a,1),1), Xmat_train_a, Xmat_train_a.^2, Xmat_train_a.^3, Xmat_train_a.^4];
<span class="comment">%X = [ ones(size(Xmat_train_a,1),1), abs(log(Xmat_train_a)), abs(log(Xmat_train_a)).^2];</span>
[b,bint,r,rint,stats] = regress(Y,X);
</pre><h2>Regress Test<a name="9"></a></h2><pre class="codeinput"><span class="comment">%scaleData = [];</span>
<span class="comment">%scaleData.shift = -mean(Xmat_train);</span>
<span class="comment">%stdVal = std(Xmat_train);</span>
<span class="comment">%scaleData.scaleFactor = 1./stdVal;</span>
<span class="comment">%scaleData.scaleFactor(~isfinite(scaleData.scaleFactor)) = 1;</span>

<span class="comment">% include a subset of the distances measured</span>
class_label = 4:1:7;
Xmat_temp = [];
Ymat_temp = [];
<span class="keyword">for</span> j = 1:length(class_label)
   I = find(Ymat_test == class_label(j));
   Xmat_temp = [Xmat_temp; Xmat_test(I,:)];
   Ymat_temp = [Ymat_temp; Ymat_test(I)];
<span class="keyword">end</span>
Xmat_test_2 = Xmat_temp;
Ymat_test_2 = Ymat_temp;

keep_i = ones(size(Xmat_test_2,1),1);
<span class="keyword">for</span> i=1:size(Xmat_test_2,1)
   <span class="keyword">if</span>  Xmat_test_2(i,1) &gt; (mean(Xmat_train(:,1)) + std(Xmat_train(:,1)))
       keep_i(i) = 0;
   <span class="keyword">end</span>
<span class="keyword">end</span>
Xmat_test_2 = Xmat_test_2(logical(keep_i),:);
Ymat_test_2 = Ymat_test_2(logical(keep_i),:);

Xmat_test_a = [];
<span class="keyword">for</span> i=1:size(Xmat_test_2,2)
    Xmat_test_a(:,i) = scaleData.scaleFactor(i)*(Xmat_test_2(:,i) + scaleData.shift(i));
<span class="keyword">end</span>
X = [ones(size(Xmat_test_a,1),1), Xmat_test_a, Xmat_test_a.^2, Xmat_test_a.^3,Xmat_test_a.^4];
<span class="comment">%X = [ ones(size(Xmat_test_a,1),1), abs(log(Xmat_test_a)), abs(log(Xmat_train_a)).^2];</span>
Y = X*b;
<span class="comment">%rid = size(Ymat_test_2,1);</span>
<span class="comment">%rid = rid(rid~=6);</span>
<span class="comment">%Ymat_test_2 = Ymat_test_2(rid,:);</span>
<span class="comment">%Y = Y(rid,:);</span>
scatter(Ymat_test_2, Y);
axis([0,7.5,0,7.5])
</pre><img vspace="5" hspace="5" src="RegressionScript_Ver03_01.png" alt=""> <p class="footer"><br>
      Published with MATLAB&reg; 7.13<br></p></div><!--
##### SOURCE BEGIN #####
%% Train Regressoin Model using historical data
% Allows for flexible selection of data
%% select the data points to get
%%
%clc;
%data_i = randperm(21);
%train_i = data_i(1:floor(length(data_i))/2);
%test_i = data_i((floor(length(data_i)/2)+1):end);
s_norm = zeros(2,1);
% index filter
train_i = 1:57;
for i = train_i
    %basePath = 'C:\Users\newton\AeroFS\NESL_Software\electrosense\DATA\ModelWeekLogOrder3\AL\';
    basePath = '/Users/newton/AeroFS/NESL_Software/electrosense/DATA/ModelWeekLogOrder3/AL/';
    [sys_train, OutputLog_a, x_a, y_a] = getData(basePath,i);

    % get singular and/or norm values
    s_norm(i) = norm(sys_train); % id model norm
end
[s_norm_sorted, H2Norm_I] = sort(s_norm);
    
%norm_limit = 0.6750;
norm_lower_limit = 0;
%norm_lower_limit = 0.685; % Determined through examination of the data
%norm_lower_limit = 0.71;
%norm_upper_limit = 0.720;
norm_upper_limit = inf;
I1 = s_norm_sorted > norm_lower_limit;
I2 = s_norm_sorted < norm_upper_limit;
I = find(I1 & I2);

% set indexes here
train_i = H2Norm_I(I);
%rand_i = randperm(length(I));
%train_i = H2Norm_I(I(rand_i(1:floor(length(I)/2))));
%test_i = H2Norm_I(I(rand_i(ceil(length(I)/2):end)));
%% Get data
%%
Anorm = zeros(2,1);
Snorm = zeros(2,1);
SnormINF = zeros(2,1);
Amat = {};
Xmat = [];
Ymat = [];
b4tharray = [];
bquadarray = [];
AnormArray = [];
xtemp = [];
ytemp = [];
for i = 1:length(train_i)  
    %basePath = 'C:\Users\newton\AeroFS\NESL_Software\electrosense\DATA\ModelWeekLogOrder3\AL\';
    %basePath = 'C:\Users\newton\AeroFS\NESL_Software\electrosense\DATA\MURI\TestDistance\Update_flaw_3\Order3\';
    basePath = '/Users/newton/AeroFS/NESL_Software/electrosense/DATA/ModelWeekLogOrder3/AL/';
    [sys_train, OutputLog, x, y] = getData(basePath,train_i(i));
   
    % get singular and/or norm values
    svd_values = svd(sys_train.A);
    Snorm(i) = norm(sys_train);
    SnormINF(i) = norm(sys_train,inf);
    
    % include averaging to estimated values
    xtemp2 = [];
    for j = 1:size(x,1)/30
       starti = 1 + (j-1)*30;
       endi = starti + 29;
       xtemp2(j,:) = mean(x(starti:endi,:));
    end
    addedFeature = kron(ones(size(xtemp2,1),1),Snorm(i));
    %xtemp2 = [xtemp2, addedFeature];
    xtemp = [xtemp; xtemp2];

    % include averaging to estimate values
    ytemp2 = [];
    for j = 1:size(y,1)/30
      starti = 1 + (j-1)*30;
      endi = starti + 29;
      ytemp2(j,:) = mean(y(starti:endi,:));
    end
    ytemp = [ytemp; ytemp2];
end

% include a subset of the distances measured
class_label = 4:1:7;
xtemp2 = [];
ytemp2 = [];
for j = 1:length(class_label)
   I = find(ytemp == class_label(j));
   xtemp2 = [xtemp2; xtemp(I,:)];
   ytemp2 = [ytemp2; ytemp(I)];
end
xtemp = xtemp2;
ytemp = ytemp2;
%% for distances 4 to 7 inches only
xtemp = exp(xtemp.*kron(ones(size(xtemp,1),1),[1000,500,5000]));

%%
%Ymat_train = ytemp;
%Ymat_test = ytemp;
%Xmat_train = xtemp;
%Xmat_test = xtemp;

%split data
P = cvpartition(ytemp,'Holdout',0.10);
Ymat_train = ytemp(P.training);
Ymat_test = ytemp(P.test);
Xmat_train = xtemp(P.training,:);
Xmat_test = xtemp(P.test,:);
%% Autoscale
scaleData = [];
scaleData.shift = -mean(Xmat_train);
stdVal = std(Xmat_train);
scaleData.scaleFactor = 1./stdVal;
scaleData.scaleFactor(~isfinite(scaleData.scaleFactor)) = 1;
Xmat_train_a = [];
for i=1:size(Xmat_train,2)
    Xmat_train_a(:,i) = scaleData.scaleFactor(i)*(Xmat_train(:,i) + scaleData.shift(i));
end
%% Regress Train
Y = Ymat_train;
X = [ ones(size(Xmat_train_a,1),1), Xmat_train_a, Xmat_train_a.^2, Xmat_train_a.^3, Xmat_train_a.^4];
%X = [ ones(size(Xmat_train_a,1),1), abs(log(Xmat_train_a)), abs(log(Xmat_train_a)).^2];
[b,bint,r,rint,stats] = regress(Y,X);
%% Regress Test
%scaleData = [];
%scaleData.shift = -mean(Xmat_train);
%stdVal = std(Xmat_train);
%scaleData.scaleFactor = 1./stdVal;
%scaleData.scaleFactor(~isfinite(scaleData.scaleFactor)) = 1;

% include a subset of the distances measured
class_label = 4:1:7;
Xmat_temp = [];
Ymat_temp = [];
for j = 1:length(class_label)
   I = find(Ymat_test == class_label(j));
   Xmat_temp = [Xmat_temp; Xmat_test(I,:)];
   Ymat_temp = [Ymat_temp; Ymat_test(I)];
end
Xmat_test_2 = Xmat_temp;
Ymat_test_2 = Ymat_temp;

keep_i = ones(size(Xmat_test_2,1),1);
for i=1:size(Xmat_test_2,1)
   if  Xmat_test_2(i,1) > (mean(Xmat_train(:,1)) + std(Xmat_train(:,1)))
       keep_i(i) = 0;
   end
end
Xmat_test_2 = Xmat_test_2(logical(keep_i),:);
Ymat_test_2 = Ymat_test_2(logical(keep_i),:);

Xmat_test_a = [];
for i=1:size(Xmat_test_2,2)
    Xmat_test_a(:,i) = scaleData.scaleFactor(i)*(Xmat_test_2(:,i) + scaleData.shift(i));
end
X = [ones(size(Xmat_test_a,1),1), Xmat_test_a, Xmat_test_a.^2, Xmat_test_a.^3,Xmat_test_a.^4];
%X = [ ones(size(Xmat_test_a,1),1), abs(log(Xmat_test_a)), abs(log(Xmat_train_a)).^2];
Y = X*b;
%rid = size(Ymat_test_2,1);
%rid = rid(rid~=6);
%Ymat_test_2 = Ymat_test_2(rid,:);
%Y = Y(rid,:);
scatter(Ymat_test_2, Y);
axis([0,7.5,0,7.5])
##### SOURCE END #####
--></body></html>